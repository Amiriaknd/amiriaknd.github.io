<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HTML-Parser 1 · Lord Camelot</title><meta name="description" content="HTML-Parser 1 - Amiria"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Lord Camelot"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">月光食堂</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="mailto:amiriaknd@outlook.com" target="_self" class="nav-list-link">MAILTOME</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HTML-Parser 1</h1><div class="post-info">Jun 13, 2017</div><div class="post-content"><p>Vue的注释中，有一个simplehtmlparser</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; HTML Parser By John Resig (ejohn.org)</div><div class="line">&gt; Modified by Juriy <span class="string">"kangax"</span> Zaytsev</div><div class="line">&gt; Original code by Erik Arvidsson, Mozilla Public License</div><div class="line">&gt; http:<span class="comment">//erik.eae.net/simplehtmlparser/simplehtmlparser.js</span></div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<hr>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><h4 id="startTag"><a href="#startTag" class="headerlink" title="startTag"></a>startTag</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">startTagRe:    <span class="regexp">/^&lt;([^&gt;\s\/]+)((\s+[^=&gt;\s]+(\s*=\s*((\"[^"]*\")|(\'[^']*\')|[^&gt;\s]+))?)*)\s*\/?\s*&gt;/m</span></div></pre></td></tr></table></figure>
<p>开标签的正则表达式<br>通常来说开标签的形式是形如<code>&lt;img src=&quot;./test.png&quot; /&gt;</code>这样的格式</p>
<blockquote>
<p><code>^&lt;</code>    以&lt;开头<br><code>([^&gt;\s\/]+)</code>    标签的tagName，这个tagName是紧紧跟在&lt;后面的，所以不能有空白。而标签又必须存在，&lt;后面不能直接跟/&gt;或&gt;，因此tagName必须是/和&gt;以外的字符且长度大于0<br>本来tagName还应该有其他的限制，如必须以字母或下划线开头，不能包含&lt;”‘等字符。但为了方便理解先不考虑。<br><code>(</code></p>
<blockquote>
<p><code>(</code><br><code>\s+</code>     img和src中间存在起码一个长度的空白<br><code>[^=&gt;\s]+</code>     属性名src，倘如存在属性的话，属性名也必须存在，所以不能直接跟=，&gt;和空白（属性名的合法性先不考虑</p>
<blockquote>
<p> <code>(</code><br><code>\s*=\s*</code>   <code>src=&quot;...&quot;</code>  中的<code>=</code>，两边允许有空白</p>
<blockquote>
<p><code>(</code><br><code>(\&quot;[^&quot;]*\&quot;)</code>    属性key=value中value的一种形式，如果value是”./xxx”这样的形式的话，双引号中间不能再有双引号<br>|<br><code>(\&#39;[^&#39;]*\&#39;)</code>     同上，value的单引号形式<br>|<br><code>[^&gt;\s]+</code>      value的第三种形式，形如checked=checked这样的形式，仅限于少数的几个属性（这里先不做限制考虑）<br>因为上面已经有了等号，所以后面不能为空，也不能直接跟&gt;</p>
<p><code>)</code></p>
</blockquote>
<p><code>)?</code>         这个括号中模式匹配的内容是<code>=&quot;./test.png&quot;</code>，由于有checked, disabled这样不需要赋值的属性存在，所以是可选的</p>
</blockquote>
<p><code>)*</code>         这个括号匹配的是<code>src=&quot;./test.png&quot;</code>，属性是可选的，因此有数量修饰符*</p>
</blockquote>
<p><code>)</code><br><code>\s*</code>     属性和/&gt;中间的空白<br><code>\/?</code>     部分自闭合标签如<code>&lt;img /&gt;</code>中的/，也是可选的<br><code>\s</code>      /和&gt;中间的空白<br><code>&gt;</code>     开标签的结尾&gt;</p>
</blockquote>
<p>看着很长，但是仔细分析一下的话也不算难理解，而且这个正则忽略了很多情况，但好在整体功能已经全备<br><code>m</code>修饰符表示会进行多行匹配</p>
<hr>
<h4 id="endTag"><a href="#endTag" class="headerlink" title="endTag"></a>endTag</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">endTagRe:    <span class="regexp">/^&lt;\/([^&gt;\s]+)[^&gt;]*&gt;/m</span></div></pre></td></tr></table></figure>
<p>闭标签<br>形如<code>&lt;/span&gt;</code><br><code>^&lt;</code>    以&lt;开头<br><code>\/</code>      &lt;之后的/<br><code>([^&gt;\s]+)</code>    span，标签名，必须存在<br><code>[^&gt;]*</code>    &gt;之前不能存在&gt;<br><code>&gt;</code>     最后的&gt;</p>
<hr>
<h4 id="attr"><a href="#attr" class="headerlink" title="attr"></a>attr</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">attrRe:        <span class="regexp">/([^=\s]+)(\s*=\s*((\"([^"]*)\")|(\'([^']*)\')|[^&gt;\s]+))?/gm</span></div></pre></td></tr></table></figure>
<p>属性的正则表达式，在开标签的表达式中已经包含它了</p>
<hr>
<h3 id="parse函数"><a href="#parse函数" class="headerlink" title="parse函数"></a>parse函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">parse: <span class="function"><span class="keyword">function</span>(<span class="params">s, oHandler</span>)</span></div></pre></td></tr></table></figure>
<p><code>parse(s, oHandler)</code>接受两个参数，一个<code>s</code>，html的原字符串，另一个<code>oHandler</code>是对解析结果的处理函数</p>
<p>跳过变量定义和循环条件</p>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (s.substring(<span class="number">0</span>, <span class="number">4</span>) == <span class="string">"&lt;!--"</span>) &#123;</div><div class="line">     index = s.indexOf(<span class="string">"--&gt;"</span>);</div><div class="line">     <span class="keyword">if</span> (index != <span class="number">-1</span>) &#123;</div><div class="line">          <span class="keyword">this</span>.contentHandler.comment(s.substring(<span class="number">4</span>, index));</div><div class="line">          s = s.substring(index + <span class="number">3</span>);</div><div class="line">          treatAsChars = <span class="literal">false</span>;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">          treatAsChars = <span class="literal">true</span>;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果s以<code>&lt;!--</code>开头，说明现在要处理的是注释，那么就找到<code>--&gt;</code>的索引，把注释截出去交给handler处理<br>如果s没有<code>--&gt;</code>，那么说明s是纯文本，将<code>treatAsChars</code>置为true</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (s.substring(<span class="number">0</span>, <span class="number">2</span>) == <span class="string">"&lt;/"</span>) &#123;</div><div class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.endTagRe.test(s)) &#123;</div><div class="line">          lc = <span class="built_in">RegExp</span>.leftContext;</div><div class="line">          lm = <span class="built_in">RegExp</span>.lastMatch;</div><div class="line">          rc = <span class="built_in">RegExp</span>.rightContext;</div><div class="line">          lm.replace(<span class="keyword">this</span>.endTagRe, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">               <span class="keyword">return</span> oThis.parseEndTag.apply(oThis, <span class="built_in">arguments</span>);</div><div class="line">          &#125;</div><div class="line">          s = rc;</div><div class="line">          treatAsChars = <span class="literal">false</span>;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">          treatAsChars = <span class="literal">true</span>;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这一段是处理闭标签，当s以<code>&lt;/</code>开头时，用闭标签的模式来进行匹配，如果匹配不到，就当作纯文本处理</p>
<p>如果能匹配的到，那么此时正则表达式的指针移动到了匹配的位置，<code>RegExp.leftContext</code>是匹配文本左边的部分，<code>RegExp.lastMatch</code>是匹配文本，而<code>RegExp.rightContext</code>就是右边的部分<br>这三个属性是落后的写法，现在应该用<code>String.Match()</code>更简便</p>
<p><code>lm.replace()</code>这一句的本意并非对lm进行替换操作，而是从lm中提取出匹配endtag的部分进行parse。<br><code>rc</code>便是匹配字符串剩下的部分，也就是剩下的html，继续循环</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (s.charAt(<span class="number">0</span>) == <span class="string">"&lt;"</span>) &#123;</div><div class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.startTagRe.test(s)) &#123;</div><div class="line">          lc = <span class="built_in">RegExp</span>.leftContext;</div><div class="line">          lm = <span class="built_in">RegExp</span>.lastMatch;</div><div class="line">          rc = <span class="built_in">RegExp</span>.rightContext;</div><div class="line">          lm.replace(<span class="keyword">this</span>.startTagRe, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">               <span class="keyword">return</span> oThis.parseStargTag.apply(oThis, <span class="built_in">arguments</span>);</div><div class="line">          &#125;</div><div class="line">          s = rc;</div><div class="line">          treatAsChars = <span class="literal">false</span>;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">          treatAsChars = <span class="literal">true</span>;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>处理开标签，和闭标签没什么区别</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (treatAsChars) &#123;</div><div class="line">     index = s.indexOf(<span class="string">"&lt;"</span>);</div><div class="line">     <span class="keyword">if</span> (index == <span class="number">-1</span>) &#123;</div><div class="line">          <span class="keyword">this</span>.contentHandler.characters(s);</div><div class="line">          s = <span class="string">""</span>;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">this</span>.contentHandler.characters(s.substring(<span class="number">0</span>, index));</div><div class="line">          s = substring(index);</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>处理纯文本，首先要确定纯文本到底有多长，也就是找到下一个tag的位置，即<code>&lt;</code>在s中的索引</p>
<p>如果<code>&lt;</code>没有了，也就是s剩下的全都是文本，直接交给handler<br>如果找到了<code>&lt;</code>，那么就截出文本交给handler，剩下的部分继续循环</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">treatAsChars = <span class="literal">true</span>;</div></pre></td></tr></table></figure>
<p>倘若上面那些关于注释和标签的判断都没有命中，那么就当作纯文本，会在下一个循环的时候被处理</p>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">parseStartTag: <span class="function"><span class="keyword">function</span>(<span class="params">sTag, sTagName, sRest</span>) </span>&#123;</div><div class="line">     <span class="keyword">var</span> attrs = <span class="keyword">this</span>.parseAttributes(sTagName, sRest);</div><div class="line">     <span class="keyword">this</span>.contentHandler.startElement(sTagName, attrs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里是对开标签进行parse<br>由于上下文环境是<code>oThis</code>，因此可以照常调用<code>this</code><br>这个函数是作为replace函数的replacer而存在的，观察startTag的正则表达式可以知道<br><code>p0</code>是整个标签，<code>p1</code>是<code>tagName</code>，<code>p2</code>是属性，分别对应<code>sTag</code>, <code>sTagName</code>, <code>sRest</code><br>继续parse属性，然后把结果和tagname一起交给handler</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">parseEndTag: <span class="function"><span class="keyword">function</span>(<span class="params">sTag, sTagName</span>) </span>&#123;</div><div class="line">     <span class="keyword">this</span>.contentHandler.endElement(sTagName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>闭标签的<code>p0</code>是整个标签，<code>p1</code>是tagname</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">parseAttributes: <span class="function"><span class="keyword">function</span>(<span class="params">sTagName, s</span>) </span>&#123;</div><div class="line">     <span class="keyword">var</span> oThis = <span class="keyword">this</span>;</div><div class="line">     <span class="keyword">var</span> attrs = [];</div><div class="line">     s.replace(<span class="keyword">this</span>.attrRe, <span class="function"><span class="keyword">function</span>(<span class="params">a0, a1, a2, a3, a4, a5, a6</span>) </span>&#123;</div><div class="line">          attrs.push(oThis.parseAttribute(sTagName, a0, a1, a2, a3, a4, a5, a6));</div><div class="line">     &#125;);</div><div class="line">     <span class="keyword">return</span> attrs;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个s是包含所有的属性在内的字符串<br>因此使用replace找到所有匹配属性的字符串分别进行处理，并放入attrs数组中，最后返回attrs<br>对于属性<code>type=&quot;text&quot;</code><br>a0: <code>match</code> – <code>type=&quot;text&quot;</code><br>a1: <code>([^=\s]+)</code> –     <code>type</code><br>a2: <code>(\s*=\s*((\&quot;([^&quot;]*)\&quot;)|(\&#39;([^&#39;]*)\&#39;)|[^&gt;\s]+))</code> –  <code>=&quot;text&quot;</code><br>a3: <code>((\&quot;([^&quot;]*)\&quot;)|(\&#39;([^&#39;]*)\&#39;)|[^&gt;\s]+)</code>  –  <code>&quot;text&quot;</code><br>a4: <code>(\&quot;([^&quot;]*)\&quot;)</code> – <code>&quot;text&quot;</code><br>a5: <code>([^&quot;]*)</code> –  <code>text</code><br>a6: <code>(\&#39;([^&#39;]*)\&#39;)</code>   –  <code>undefined</code><br>a7: <code>([^&#39;]*)</code>  –  <code>undefined</code><br>a8: <code>offset</code> –  <code>0</code><br>a9: <code>string</code>  – <code>type=&quot;text&quot;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">parseAttributes: <span class="function"><span class="keyword">function</span>(<span class="params">sTagName, sAttribute, sName</span>) </span>&#123;</div><div class="line">     <span class="keyword">var</span> value = <span class="string">""</span>;</div><div class="line">     <span class="keyword">if</span> (<span class="built_in">arguments</span>[<span class="number">7</span>]) &#123;</div><div class="line">          value = <span class="built_in">arguments</span>[<span class="number">8</span>];</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">arguments</span>[<span class="number">5</span>]) &#123;</div><div class="line">          value = <span class="built_in">arguments</span>[<span class="number">6</span>];</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">arguments</span>[<span class="number">3</span>]) &#123;</div><div class="line">          value = <span class="built_in">arguments</span>[<span class="number">4</span>];</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">var</span> empty = !value &amp;&amp; !<span class="built_in">arguments</span>[<span class="number">3</span>];</div><div class="line">     <span class="keyword">return</span> &#123;</div><div class="line">          name: sName,</div><div class="line">          value: empty ? <span class="literal">null</span> : value</div><div class="line">     &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>arguments[7] ==&gt; a6</code> 单引号的情况，如果a6有值，那就取出aruments[8]也就是a7的值<br><code>arguments[5] ==&gt; a4</code> 双引号的情况，同上，如果有值就取a5<br><code>arguments[3] ==&gt; a2</code> 整个后半部分。如果既不是单引号也不是双引号，而a2有值，那么说明是<code>checked=checked</code>的情况，这个时候直接a3的值为去掉等号的<code>checked</code><br>如果遍历完情况value的值依然为空，那么就检查一下a2是否为空，如果a2也为空，说明是<code>checked</code>的形式，value为<code>null</code></p>
<p>为什么要对<code>arguments[3]</code>进行一次重复的判断？<br>因为可能存在value为空字符串的情况<br>如果value是空字符串，那么<code>!value === true &amp;&amp; !arguments[3] === false</code>这种情况是存在的，此时显然不能将value设置为null<br>而<code>arguments[3]</code>如果为空，那么value一定不存在，可以安心将它设置为null</p>
<hr>
<blockquote>
<p>勘误：关于<code>checked=checked</code>，并非是只有这种情况。HTML标准并没有强制要求value要加引号，只不过不加引号常常会导致引发错误如<code>&lt;img src=w3c school&gt;</code>所以不怎么推荐使用。因此，属性判断中的第三个条件是对这种情况的处理</p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/2017/06/14/2017-06-14/" class="prev">PREV</a><a href="/2017/06/09/2017-06-09/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Amiria</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>