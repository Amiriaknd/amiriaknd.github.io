<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HTML-Parser 2 · Lord Camelot</title><meta name="description" content="HTML-Parser 2 - Amiria"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Lord Camelot"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">月光食堂</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="mailto:amiriaknd@outlook.com" target="_self" class="nav-list-link">MAILTOME</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HTML-Parser 2</h1><div class="post-info">Jun 14, 2017</div><div class="post-content"><p>根据上一篇文章，结合Vue源码，尝试进行一个简单的HTML-Parser实现</p>
<a id="more"></a>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>根据<a href="https://www.w3.org/TR/html51/syntax.html" target="_blank" rel="external">W3C的文档</a></p>
<blockquote>
<p>Attributes have a name and a value. Attribute names must consist of one or more characters other than the space characters, U+0000 NULL, U+0022 QUOTATION MARK (“), U+0027 APOSTROPHE (‘), U+003E GREATER-THAN SIGN (&gt;), U+002F SOLIDUS (/), and U+003D EQUALS SIGN (=) characters, the control characters, and any characters that are not defined by Unicode. </p>
</blockquote>
<p>可知属性名的模式<code>[^\s&quot;&#39;&gt;\/=]</code>，同时不能为<code>null</code>，所以得到<code>/[^\s&quot;&#39;&gt;\/=]+/</code></p>
<hr>
<p>值可以分为四种：</p>
<h5 id="1-Empty-attribute-syntax"><a href="#1-Empty-attribute-syntax" class="headerlink" title="1.Empty attribute syntax"></a>1.Empty attribute syntax</h5><blockquote>
<p>If an attribute using the empty attribute syntax is to be followed by another attribute, then there must be a space character separating the two.</p>
</blockquote>
<p>因此整个的属性模式需要以至少一个空白字符开头</p>
<h5 id="2-Unquoted-attribute-value-syntax"><a href="#2-Unquoted-attribute-value-syntax" class="headerlink" title="2.Unquoted attribute value syntax"></a>2.Unquoted attribute value syntax</h5><blockquote>
<p>The attribute name, followed by zero or more space characters, followed by a single U+003D EQUALS SIGN character, followed by zero or more space characters, followed by the attribute value</p>
</blockquote>
<p>这段话可以得出<code>\s*=\s*</code></p>
<blockquote>
<p>attribute value, which, in addition to the requirements given above for attribute values, must not contain any literal space characters, any U+0022 QUOTATION MARK characters (“), U+0027 APOSTROPHE characters (‘), U+003D EQUALS SIGN characters (=), U+003C LESS-THAN SIGN characters (&lt;), U+003E GREATER-THAN SIGN characters (&gt;), or U+0060 GRAVE ACCENT characters (`), and must not be the empty string.</p>
</blockquote>
<p>可得<code>[^\s&quot;&#39;=&lt;&gt;</code>]+<code>即没有引号的情况下，值的模式是</code>/\s<em>=\s</em>[^\s”‘=&lt;&gt;<code>]+/</code></p>
<h5 id="3-Single-quoted-attribute-value-syntax"><a href="#3-Single-quoted-attribute-value-syntax" class="headerlink" title="3.Single-quoted attribute value syntax"></a>3.Single-quoted attribute value syntax</h5><blockquote>
<p>The attribute name, followed by zero or more space characters, followed by a single U+003D EQUALS SIGN character, followed by zero or more space characters, followed by a single U+0027 APOSTROPHE character (‘), followed by the attribute value, which, in addition to the requirements given above for attribute values, must not contain any literal U+0027 APOSTROPHE characters (‘), and finally followed by a second single U+0027 APOSTROPHE character (‘).</p>
</blockquote>
<p>可得<code>/\s*=\s*&#39;[^&#39;]*&#39;/</code></p>
<h5 id="4-Double-quoted-attribute-value-syntax"><a href="#4-Double-quoted-attribute-value-syntax" class="headerlink" title="4.Double-quoted attribute value syntax"></a>4.Double-quoted attribute value syntax</h5><blockquote>
<p>The attribute name, followed by zero or more space characters, followed by a single U+003D EQUALS SIGN character, followed by zero or more space characters, followed by a single U+0022 QUOTATION MARK character (“), followed by the attribute value, which, in addition to the requirements given above for attribute values, must not contain any literal U+0022 QUOTATION MARK characters (“), and finally followed by a second single U+0022 QUOTATION MARK character (“).</p>
</blockquote>
<p>和第三种情况差不多，即<code>/\s*=\s*&quot;[^&quot;]*&quot;/</code></p>
<p>综合一下，可以发现空值对值的模式没有要求，只要在整个属性的前面加上空白字符就可以了。其他三个模式等号部分是一样的，只有后面的不同<br>因此可以得出值的模式/\s<em>=\s</em>(“[^”]<em>“|’[^’]</em>‘|[^\s”‘=&lt;&gt;`]+)/，然而由于有空值的存在，因此这个模式应当是可选的</p>
<hr>
<p>对比一下vue的属性匹配模式/^\s<em>([^\s”‘&lt;&gt;\/=]+)(?:\s</em>((?:=))\s<em>( ?:”([^”]</em>)”+|’([^’]*)’+|([^\s”‘=&lt;&gt;`]+) )?/</p>
<p>vue一开始的\s是*而非+，不是很理解<br>关于属性名的判断vue加上了对&lt;的限制，考虑的更加全面<br>还有双引号和单引号的情况vue加上了+修饰，感觉不是很有必要？如果是引号属性的话必定有而且只有一对存在吧<br>同时为了方便分析，为需要的内容加上括号来捕获它们</p>
<p>最终定下来属性模式为<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> attrRe = <span class="regexp">/^\s+([^\s"'&lt;&gt;\/=]+)(\s*=\s*(("([^"]*)")|('([^']*)')|[^\s"'=&lt;&gt;`]+))?/g</span></div></pre></td></tr></table></figure></p>
<h4 id="开标签"><a href="#开标签" class="headerlink" title="开标签"></a>开标签</h4><p>接下来是开标签，既然已经有了属性，那么开标签就很容易分析了</p>
<blockquote>
<p>Start tags must have the following format:</p>
<pre><code>1. The first character of a start tag must be a U+003C LESS-THAN SIGN character (&lt;).
2. The next few characters of a start tag must be the element’s tag name.
3. If there are to be any attributes in the next step, there must first be one or more space characters.
4. Then, the start tag may have a number of attributes, the syntax for which is described below. Attributes must be separated from each other by one or more space characters.
5. After the attributes, or after the tag name if there are no attributes, there may be one or more space characters. (Some attributes are required to be followed by a space. See §8.1.2.3 Attributes below.)
6. Then, if the element is one of the void elements, or if the element is a foreign element, then there may be a single U+002F SOLIDUS character (/). This character has no effect on void elements, but on foreign elements it marks the start tag as self-closing.
7. Finally, start tags must be closed by a U+003E GREATER-THAN SIGN character (&gt;).
</code></pre></blockquote>
<p>本来tagname应该是固定的，但是考虑到自定义标签，应当将范围扩大到合法的标识符，结合vue的源码，得到tagname模式为<code>[a-zA-z_][\s\-\.]*</code>。<br>这里有一点，由于tagname起码要有一个字符，因此第一个[]是必须有的，第二个[]是可选的，*只会修饰第二个[]。</p>
<p>可以根据上面的规则得出开标签的正则表达式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> startTagRe = <span class="regexp">/^&lt;([a-zA-z_][\s\-\.]*)(\s+([^\s"'&lt;&gt;\/=]+)(\s*=\s*(("([^"]*)")|('([^']*)')|[^\s"'=&lt;&gt;`]+))?)*\s*\/?\s*&gt;/</span></div></pre></td></tr></table></figure></p>
<h4 id="闭标签"><a href="#闭标签" class="headerlink" title="闭标签"></a>闭标签</h4><p>最后是闭标签</p>
<blockquote>
<p>End tags must have the following format:</p>
<pre><code>1. The first character of an end tag must be a U+003C LESS-THAN SIGN character (&lt;).
2. The second character of an end tag must be a U+002F SOLIDUS character (/).
3. The next few characters of an end tag must be the element’s tag name.
4. After the tag name, there may be one or more space characters.
5. Finally, end tags must be closed by a U+003E GREATER-THAN SIGN character (&gt;).
</code></pre></blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> endTagRe = <span class="regexp">/^&lt;[a-zA-Z_][\w\-\.]*\s*&gt;/</span></div></pre></td></tr></table></figure>
<h4 id="DOCTYPE"><a href="#DOCTYPE" class="headerlink" title="DOCTYPE"></a>DOCTYPE</h4><blockquote>
<p>A DOCTYPE must consist of the following components, in this order:</p>
<pre><code>1. A string that is an ASCII case-insensitive match for the string &quot;&lt;!DOCTYPE&quot;.
2. One or more space characters.
3. A string that is an ASCII case-insensitive match for the string &quot;html&quot;.
4. Optionally, a DOCTYPE legacy string or an obsolete permitted DOCTYPE string (defined below).
5. Zero or more space characters.
6. A U+003E GREATER-THAN SIGN character (&gt;).
</code></pre></blockquote>
<p>这里需要用到<code>[^&gt;]</code>了，因为这里并不能确定doctype后面会跟怎样的字符，而且这些字符必须存在<br>同时由于doctype是不区分大小写的，要加上ignore来修饰<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> doctypeRe = <span class="regexp">/!DOCTYPE [^&gt;]+&gt;/i</span></div></pre></td></tr></table></figure></p>
<h4 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h4><p>注释不需要用正则表达式表达式匹配，找到注释的<code>&lt;!--</code>后直接寻找<code>--&gt;</code>就可以了</p>
<h3 id="Parse"><a href="#Parse" class="headerlink" title="Parse"></a>Parse</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">parse: <span class="function"><span class="keyword">function</span>(<span class="params">html, handler</span>) </span>&#123;</div><div class="line">     <span class="keyword">while</span>(html.length &gt; <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">// main </span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (html.startsWith(<span class="string">'&lt;!--'</span>)) &#123;</div><div class="line">     <span class="keyword">let</span> index = html.indexOf(<span class="string">'--&gt;'</span>);</div><div class="line">     <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line">          html = <span class="string">''</span>;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">          handler.handleComment(html.slice(<span class="number">4</span>, index));</div><div class="line">          html = html.slice(index + <span class="number">3</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">continue</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>匹配注释</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (doctypeRe.test(html)) &#123;</div><div class="line">     <span class="keyword">let</span> result = doctypeRe.exec(html);</div><div class="line">     handler.handleDoctype(result[<span class="number">0</span>]);</div><div class="line">     html = html.slice(result[<span class="number">0</span>].length);</div><div class="line">     <span class="keyword">continue</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (startTagRe.test(html)) &#123;</div><div class="line">     <span class="keyword">let</span> result = startTagRe.exec(html);</div><div class="line">     handler.parseStartTag(result[<span class="number">0</span>]);</div><div class="line">     html = html.slice(result[<span class="number">0</span>].length);</div><div class="line">     <span class="keyword">continue</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (endTagRe.test(html)) &#123;</div><div class="line">     <span class="keyword">let</span> result = endTagRe.exec(html);</div><div class="line">     handler.handleEndTag(result[<span class="number">0</span>]);</div><div class="line">     html = html.slice(result[<span class="number">0</span>].length);</div><div class="line">     <span class="keyword">continue</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>doctype和开标签闭标签基本一样，而且也很简单，但是由于开标签需要额外进行一下属性处理，所以不直接调用handler</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> nextTag = html.index(<span class="string">'&lt;'</span>);</div><div class="line"><span class="keyword">if</span> (nextTag &lt; <span class="number">0</span>) &#123;</div><div class="line">     <span class="keyword">this</span>.handler.handleText(html);</div><div class="line">     html = <span class="string">''</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">     <span class="keyword">this</span>.handler.handleText(html.slice(<span class="number">0</span>, nextTag));</div><div class="line">     html = html.slice(nextTag);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>倘若以上都没有匹配到的话，说明现在正在标签的内部，要检测的是文本</p>
<p>处理完以后需要寻找下一个标签，如果没有找到，那么剩下的html全部都是文本，如果找到了就截出需要的文本</p>
<hr>
<p><strong>parse开标签</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">parseStartTag: <span class="function"><span class="keyword">function</span>(<span class="params">starTag</span>)</span></div></pre></td></tr></table></figure></p>
<p>首先要从开标签中找到tagname和属性<br>根据表达式/^&lt;([a-zA-z_][\s-.]<em>)(\s+([^\s”‘&lt;&gt;\/=]+)(\s</em>=\s<em>((“([^”]</em>)”)|(‘([^’]<em>)’)|[^\s”‘=&lt;&gt;`]+))?)</em>\s<em>\/?\s</em>&gt;/</p>
<p><code>$1</code>是<code>tagname</code>，<code>$2</code>是属性（如果有的话）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> match = startTagRe.exec(startTag);</div><div class="line"><span class="keyword">this</span>.handleStartTag(match[<span class="number">1</span>]);</div><div class="line"><span class="keyword">this</span>.parseAttributes(match[<span class="number">2</span>]);</div></pre></td></tr></table></figure>
<p><strong>parse属性</strong><br>/^\s+([^\s”‘&lt;&gt;\/=]+)(\s<em>=\s</em>((“([^”]<em>)”)|(‘([^’]</em>)’)|[^\s”‘=&lt;&gt;`]+))?/</p>
<p>这里进行分析的时候要用到replace，它会对global匹配的所有字符串进行函数的调用<br>对于属性，<code>$1</code>是<code>name</code>，<code>$2</code>是后半部分，可以用来判断是否存在值，<code>$3</code>是value部分，<code>$4</code>，<code>$5</code>是双引号和双引号内部的值，<code>$6</code>，<code>$7</code>是单引号及其内部的值<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">parseAttributes: <span class="function"><span class="keyword">function</span>(<span class="params">attributes</span>) </span>&#123;</div><div class="line">     attributes.replce(attrRe, <span class="function"><span class="keyword">function</span>(<span class="params">attr, a1, a2, a3, a4, a5, a6, a7</span>) </span>&#123;</div><div class="line">          <span class="keyword">let</span> value = <span class="string">''</span>;</div><div class="line">          <span class="comment">// 是否是双引号</span></div><div class="line">          <span class="keyword">if</span> (a4) &#123;</div><div class="line">               value = a5;</div><div class="line">          <span class="comment">// 是否是单引号</span></div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a6) &#123;</div><div class="line">               value = a7;</div><div class="line">          <span class="comment">// 是否存在后半部分</span></div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a3) &#123;</div><div class="line">               value = a4;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// 检测空字符串的情况，并确认a3为空</span></div><div class="line">          <span class="keyword">let</span> empty = !value &amp;&amp; !a3;</div><div class="line">          handler.handleAttr(&#123;</div><div class="line">               name: a1,</div><div class="line">               value: empty ? <span class="literal">null</span> : value</div><div class="line">          &#125;);</div><div class="line">     &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>以上就完成了文本解析的工作<br>关于handler的话，不同的需求实现也不同，不再多谈了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/07/06/2017-07-06/" class="prev">PREV</a><a href="/2017/06/13/2017-06-13/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Amiria</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>